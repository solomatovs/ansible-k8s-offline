FROM debian:bullseye-slim

RUN apt-get update && apt-get install -y \
    bash \
    build-essential \
    curl \
    ca-certificates \
    tar \
    git \
    pkg-config \
    musl-dev \
    libseccomp-dev \
&& rm -rf /var/lib/apt/lists/*

# Копируем go bootstrap внутрь контейнера
COPY {{ go_bootstrap_bin }} /usr/local/
# Копируем исходники внутрь контейнера
COPY {{ archive_src }} /app/src/

# Распаковываем
RUN  mkdir /usr/local/go \
    && tar -xzf /usr/local/{{ go_bootstrap_bin }} -C /usr/local/go \
    && tar -xzf /app/src/{{ archive_src }} -C /app/src --strip-components=1

# Компилируем runc
WORKDIR /app/src

RUN export GOROOT=/usr/local/go \
    && export PATH=$PATH:/usr/local/go/bin \
    && export CGO_ENABLED=0 \
    && export GOFLAGS="-buildvcs=false" \
    && export GOPROXY="{{ go_proxy_url }}" \
    && export BUILDTAGS="seccomp" \
    && git config --global --add safe.directory /app/src \
    && go mod vendor \
    && make static \
    && mkdir -p /app/bin \
    && /bin/cp -rf runc /app/bin
