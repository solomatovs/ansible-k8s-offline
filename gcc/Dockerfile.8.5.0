# Сборка GCC 8.5.0 bootstrap-компилятора системным gcc.
# GCC 8.5.0 — первая версия в цепочке, собирается штатным build-essential.
# Используется как bootstrap для компиляции более новых версий.
# Результат: /out — полный компилятор GCC (gcc, g++, runtime-библиотеки).
# Использование: COPY --from=gcc:8.5.0-build /out /

ARG BASE_IMAGE=astra-linux:2.12

FROM ${BASE_IMAGE} AS builder

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
 && apt-get install -y \
        build-essential \
        flex \
        texinfo \
        file \
        zlib1g-dev \
        libgmp-dev \
        libmpfr-dev \
        libmpc-dev \
 && rm -rf /var/lib/apt/lists/*

#### compilation ####
ARG GCC_VERSION=8.5.0

WORKDIR /build

COPY artifacts/src/gcc-${GCC_VERSION}.tar.xz /build/

RUN tar xJf gcc-${GCC_VERSION}.tar.xz \
 && rm gcc-${GCC_VERSION}.tar.xz

# GCC ОБЯЗАТЕЛЬНО собирается в отдельной директории (не в source tree)
RUN mkdir build && cd build \
 && ../gcc-${GCC_VERSION}/configure \
      --prefix=/usr \
      --libdir=/usr/lib/x86_64-linux-gnu \
      --libexecdir=/usr/lib/x86_64-linux-gnu \
      --disable-bootstrap \
      --disable-multilib \
      --enable-languages=c,c++ \
      --enable-shared \
      --enable-threads=posix \
      --with-system-zlib \
 && make -j$(nproc) \
 && make DESTDIR=/out install
#### compilation ####

# Финальный образ — только результат сборки.
FROM ${BASE_IMAGE}
COPY --from=builder /out /out
