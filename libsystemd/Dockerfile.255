# Сборка статической и динамической библиотеки libsystemd из исходников systemd v255 (meson).
# v255 требует meson >= 0.60.0 — Astra Linux 2.12 имеет только 0.49.0,
# поэтому meson устанавливается через pip3.
#
# Собираем только libsystemd — ninja собирает только библиотечные таргеты,
# демоны и утилиты не компилируются (meson-опции для них не влияют на библиотеку).
# Все C-зависимости подаются как файловые зависимости из artifacts/deps/ (make deps).
#
# Результат: /out (--prefix=/usr)
#   /out/usr/lib/libsystemd.a            — статическая библиотека
#   /out/usr/lib/libsystemd.so*          — динамическая библиотека
#   /out/usr/include/systemd/*.h         — заголовочные файлы
#   /out/usr/lib/pkgconfig/libsystemd.pc — pkg-config
# Использование: COPY --from=libsystemd:255-build /out /

ARG BASE_IMAGE=astra-linux:2.12

FROM ${BASE_IMAGE} AS builder

ARG SYSTEMD_VERSION=255
ARG LIBCAP_VERSION=2.25
ARG LIBMOUNT_VERSION=2.30.2
ARG GPG_ERROR_VERSION=1.35
ARG GCRYPT_VERSION=1.7.6
ARG SECCOMP_VERSION=2.5.5
ARG LZMA_VERSION=5.2.2
ARG LZ4_VERSION=1.9.3
ARG SELINUX_VERSION=2.6

ENV DEBIAN_FRONTEND=noninteractive

# v255 требует meson >= 0.60.0, а meson >= 0.60 требует Python >= 3.7.
# Astra Linux 2.12 имеет Python 3.5 — собираем Python 3.11 из исходников,
# затем через его pip устанавливаем meson и jinja2.
ARG PYTHON_VERSION=3.11.7

RUN apt-get update \
    && apt-get install -y \
        build-essential \
        ninja-build \
        pkg-config \
        gperf \
        m4 \
        gettext \
        libffi-dev \
        zlib1g-dev \
        libssl-dev \
 && rm -rf /var/lib/apt/lists/*

# Сборка Python 3.11 (без оптимизаций — для ускорения; нужен только для meson)
ADD https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz /tmp/
RUN cd /tmp \
 && tar xzf Python-${PYTHON_VERSION}.tgz \
 && cd Python-${PYTHON_VERSION} \
 && ./configure --prefix=/opt/python3 \
 && make -j$(nproc) \
 && make install \
 && cd / && rm -rf /tmp/Python-${PYTHON_VERSION}* \
 && /opt/python3/bin/pip3 install 'meson>=0.60,<0.64' ninja jinja2 \
 && ln -sf /opt/python3/bin/python3 /usr/local/bin/python3 \
 && ln -sf /opt/python3/bin/meson /usr/local/bin/meson \
 && ln -sf /opt/python3/bin/ninja /usr/local/bin/ninja

# C-зависимости для сборки (make deps)
COPY artifacts/deps/libcap-${LIBCAP_VERSION}.tar.gz /build/
RUN tar xzf /build/libcap-${LIBCAP_VERSION}.tar.gz -C / \
 && rm /build/libcap-${LIBCAP_VERSION}.tar.gz

COPY artifacts/deps/libmount-${LIBMOUNT_VERSION}.tar.gz /build/
RUN tar xzf /build/libmount-${LIBMOUNT_VERSION}.tar.gz -C / \
 && rm /build/libmount-${LIBMOUNT_VERSION}.tar.gz

COPY artifacts/deps/libgpg-error-${GPG_ERROR_VERSION}.tar.gz /build/
RUN tar xzf /build/libgpg-error-${GPG_ERROR_VERSION}.tar.gz -C / \
 && rm /build/libgpg-error-${GPG_ERROR_VERSION}.tar.gz

COPY artifacts/deps/libgcrypt-${GCRYPT_VERSION}.tar.gz /build/
RUN tar xzf /build/libgcrypt-${GCRYPT_VERSION}.tar.gz -C / \
 && rm /build/libgcrypt-${GCRYPT_VERSION}.tar.gz

COPY artifacts/deps/libseccomp-${SECCOMP_VERSION}.tar.gz /build/
RUN tar xzf /build/libseccomp-${SECCOMP_VERSION}.tar.gz -C / \
 && rm /build/libseccomp-${SECCOMP_VERSION}.tar.gz

COPY artifacts/deps/liblzma-${LZMA_VERSION}.tar.gz /build/
RUN tar xzf /build/liblzma-${LZMA_VERSION}.tar.gz -C / \
 && rm /build/liblzma-${LZMA_VERSION}.tar.gz

COPY artifacts/deps/liblz4-${LZ4_VERSION}.tar.gz /build/
RUN tar xzf /build/liblz4-${LZ4_VERSION}.tar.gz -C / \
 && rm /build/liblz4-${LZ4_VERSION}.tar.gz

COPY artifacts/deps/libselinux-${SELINUX_VERSION}.tar.gz /build/
RUN tar xzf /build/libselinux-${SELINUX_VERSION}.tar.gz -C / \
 && rm /build/libselinux-${SELINUX_VERSION}.tar.gz

WORKDIR /build

COPY artifacts/src/systemd-${SYSTEMD_VERSION}.tar.gz /build/

RUN mkdir -p /build/systemd \
 && tar xzf systemd-${SYSTEMD_VERSION}.tar.gz --strip-components=1 -C /build/systemd \
 && rm systemd-${SYSTEMD_VERSION}.tar.gz

WORKDIR /build/systemd

# v255: sed-патч shared_library НЕ нужен (баг линковки исправлен upstream).
# Собираем только libsystemd — ninja ниже компилирует только библиотечные таргеты.
#
# Библиотеки, встроенные в libsystemd через meson auto-detect (все из deps/):
#   libcap, libmount, libblkid, libgcrypt + libgpg-error
#   liblzma (xz), liblz4 (сжатие журналов)
#   libseccomp, libselinux + libsepol
RUN meson setup build \
      --prefix=/usr \
      --libdir=/usr/lib \
      -Drootlibdir=/usr/lib \
      -Dstatic-libsystemd=pic \
      -Dstandalone-binaries=false \
      -Dtests=false \
      -Dman=false \
      -Dhtml=false \
 && ninja -C build version.h \
 && ninja -C build libsystemd.a \
 && SO_TARGET=$(grep -m1 -oP 'build \K\S*libsystemd\.so\S*(?=\s*:)' build/build.ninja) \
 && { [ -n "$SO_TARGET" ] && ninja -C build "$SO_TARGET" || true; } \
 && mkdir -p /out/usr/lib/pkgconfig /out/usr/include/systemd \
 && find build -type f -name 'libsystemd.a' ! -name 'libsystemd_static.a' | head -1 | xargs -I{} cp {} /out/usr/lib/ \
 && find build -type f -name 'libsystemd.so.*.*.*' ! -name '*.symbols' | head -1 | xargs -I{} cp {} /out/usr/lib/ \
 && ( cd /out/usr/lib \
   && SO_REAL=$(ls libsystemd.so.*.*.* 2>/dev/null | grep -v '\.symbols$' | head -1) \
   && [ -n "$SO_REAL" ] && ln -sf "$SO_REAL" libsystemd.so.0 && ln -sf libsystemd.so.0 libsystemd.so \
   || true ) \
 && PC=$(find build -type f -name 'libsystemd.pc' | head -1) \
 && if [ -n "$PC" ]; then cp "$PC" /out/usr/lib/pkgconfig/; \
    else printf 'prefix=/usr\nexec_prefix=${prefix}\nlibdir=${prefix}/lib\nincludedir=${prefix}/include\n\nName: libsystemd\nDescription: systemd Library\nURL: https://www.freedesktop.org/wiki/Software/systemd\nVersion: %s\nLibs: -L${libdir} -lsystemd\nCflags: -I${includedir}\n' "${SYSTEMD_VERSION}" > /out/usr/lib/pkgconfig/libsystemd.pc; fi \
 && cp src/systemd/*.h /out/usr/include/systemd/ \
 && { cp build/src/systemd/*.h /out/usr/include/systemd/ 2>/dev/null || true; }

# Финальный образ — только результат сборки.
FROM ${BASE_IMAGE}
COPY --from=builder /out /out
