# Сборка Go 1.4 bootstrap-компилятора из C-исходников.
# Go 1.4 — последняя версия Go, написанная на C.
# Используется как bootstrap для компиляции более новых версий.
# Результат: /out/usr/local/go/ (bin/, pkg/, src/)
# Использование: COPY --from=golang:1.4-build /out/usr/local/go /usr/local/go

ARG BASE_IMAGE=astra-linux:2.12

FROM ${BASE_IMAGE} AS builder

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
        build-essential \
        bash \
        ca-certificates \
 && rm -rf /var/lib/apt/lists/*

#### compilation ####
ARG GOLANG_VERSION=1.4

WORKDIR /build
COPY artifacts/src/golang-${GOLANG_VERSION}.tar.gz /build/

RUN tar xzf golang-${GOLANG_VERSION}.tar.gz \
 && rm golang-${GOLANG_VERSION}.tar.gz

WORKDIR /build/go-go${GOLANG_VERSION}/src

RUN export CGO_ENABLED=0 \
 && sed -i '/"-Werror",/d' cmd/dist/build.c \
 && ./make.bash

RUN mkdir -p /out/usr/local/go \
 && cp -a /build/go-go${GOLANG_VERSION}/bin \
          /build/go-go${GOLANG_VERSION}/pkg \
          /build/go-go${GOLANG_VERSION}/src \
          /out/usr/local/go/
#### compilation ####

# Финальный образ — только результат сборки.
FROM ${BASE_IMAGE}
COPY --from=builder /out /out
